{% extends 'base.html.twig' %}

{% block title %}Alimentación Saludable - Vida Saludable{% endblock %}

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/style.css') }}">
{% endblock %}

{% block body %}
{# Menú desplegable del perfil de usuario #}


<header class="header text-center">
{% if app.session.get('nombre') is not null %}
    <div class="dropdown position-fixed top-0 end-0 m-3">
        <button class="btn btn-light dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="{{ asset('img/pefil.png') }}" alt="Perfil" width="32" height="32" class="rounded-circle me-2">
            {{ app.session.get('nombre')|escape('html') }}
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item text-danger" href="{{ path('app_logout') }}">Cerrar sesión</a></li>
        </ul>
    </div>
{% endif %}
    <div class="header-content">
        <h1>Alimentación Saludable</h1>
        <p>Descubre cómo calcular tus calorías diarias y obtener recomendaciones de dietas saludables.</p>
    </div>
    <nav class="main-nav">
        <ul>
            <li><a href="{{ path('main_inicio') }}">Inicio</a></li>
            <li><a href="{{ path('ejercicio') }}">Ejercicio Físico</a></li>
            <li><a href="{{ path('salud_mental') }}">Salud Mental</a></li>
        </ul>
    </nav>
</header>

<main class="container my-5">
    {# Bloque de resultado de calorías #}
    {% if tmb is defined and tmb is not null %}
        <div id="resultado-calorias" class="alert alert-success text-center shadow-sm mb-4">
            <h2>Resultado</h2>
            <p>Tu requerimiento calórico diario estimado es:</p>
            <p class="display-4"><strong>{{ tmb|round }} kcal</strong></p>
            <p>¡Utiliza este dato para planificar tus comidas y mantenerte saludable!</p>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const resultado = document.getElementById('resultado-calorias');
                if (resultado) {
                    resultado.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                const collapseElement = document.getElementById('calculadoraCollapse');
                if (collapseElement) {
                    const bsCollapse = new bootstrap.Collapse(collapseElement, {
                        toggle: false
                    });
                    bsCollapse.show();
                }
            });
        </script>
    {% endif %}

    {# Acordeón de la Calculadora de Calorías #}
    <div class="accordion" id="calculadoraAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingCalculadora">
                <button class="accordion-button {% if tmb is defined and (tmb is not null or not isPostRequest) %}{% else %}collapsed{% endif %}"
                        type="button" data-bs-toggle="collapse" data-bs-target="#calculadoraCollapse"
                        aria-expanded="{% if tmb is defined and (tmb is not null or not isPostRequest) %}true{% else %}false{% endif %}"
                        aria-controls="calculadoraCollapse">
                    Calcula tus calorías
                </button>
            </h2>
            <div id="calculadoraCollapse" class="accordion-collapse collapse show" aria-labelledby="headingCalculadora" data-bs-parent="#calculadoraAccordion">
                <div class="accordion-body">
                    <form action="{{ path('alimentacion') }}" method="POST">

                        <div class="mb-3">
                            <label for="peso">Peso (kg):</label>
                            <input type="number" name="peso" id="peso" step="0.1" class="form-control" value="{{ datos.peso|default('') }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="altura">Altura (cm):</label>
                            <input type="number" name="altura" id="altura" class="form-control" value="{{ datos.altura|default('') }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="sexo">Sexo:</label>
                            <select name="sexo" id="sexo" class="form-control" required>
                                <option value="">Selecciona</option>
                                <option value="masculino" {% if (datos.sexo|default('')) == 'masculino' %}selected{% endif %}>Masculino</option>
                                <option value="femenino" {% if (datos.sexo|default('')) == 'femenino' %}selected{% endif %}>Femenino</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edad">Edad:</label>
                            <input type="number" name="edad" id="edad" class="form-control"
                                value="{% if edadCalculada is defined and edadCalculada is not empty %}{{ edadCalculada }}{% else %}{{ datos.edad|default('') }}{% endif %}"
                                {% if edadCalculada is defined and edadCalculada is not empty %}readonly{% endif %} required>
                        </div>
                        <div class="mb-3">
                            <label for="objetivo">¿Cuál es tu objetivo?</label>
                            <select name="objetivo" id="objetivo" class="form-control" required>
                                <option value="">Selecciona</option>
                                <option value="perder_peso" {% if (objetivo|default('')) == 'perder_peso' %}selected{% endif %}>Bajar de peso</option>
                                <option value="mantener_peso" {% if (objetivo|default('')) == 'mantener_peso' %}selected{% endif %}>Mantener el peso</option>
                                <option value="ganar_musculo" {% if (objetivo|default('')) == 'ganar_musculo' %}selected{% endif %}>Ganar masa muscular</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ejercicio">Cantidad de ejercicio semanal:</label>
                            <select name="ejercicio" id="ejercicio" class="form-control" required>
                                <option value="">Selecciona</option>
                                <option value="sedentario" {% if (ejercicio|default('')) == 'sedentario' %}selected{% endif %}>Sedentario (poco o ningún ejercicio)</option>
                                <option value="ligero" {% if (ejercicio|default('')) == 'ligero' %}selected{% endif %}>Ligero (1-3 días/semana)</option>
                                <option value="moderado" {% if (ejercicio|default('')) == 'moderado' %}selected{% endif %}>Moderado (3-5 días/semana)</option>
                                <option value="intenso" {% if (ejercicio|default('')) == 'intenso' %}selected{% endif %}>Intenso (6-7 días/semana)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Calcular</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Mostrar dietas recomendadas #}
    {% if tmb is defined and tmb is not null and dietasRecomendadas is defined and dietasRecomendadas is not null %}
        {% set dietasParaMostrar = [] %}
        {% if dietasRecomendadas is iterable %}
            {% set dietasArray = dietasRecomendadas|sort((a, b) => (a.calorias ?? 0) - tmb) %}
            {% set dietasParaMostrar = dietasArray|slice(0, 6) %}
        {% endif %}

        {% if dietasParaMostrar is not empty %}
            <div class="mt-5">
                <h3 class="text-center mb-3">Dietas recomendadas según tus calorías</h3>
                <div class="row justify-content-center">
                    {% for dieta in dietasParaMostrar %}
                        <div class="col-md-4 mb-3">
                            <div class="card shadow-sm h-100">
                                <div class="card-body">
                                    <h5 class="card-title">{{ dieta.nombre|default('Dieta sin nombre')|escape('html') }}</h5>
                                    <p><strong>Calorías:</strong> {{ dieta.calorias|default('N/A')|escape('html') }} kcal</p>
                                    <p><strong>Alimentos:</strong></p>
                                    <ul class="list-unstyled small">
                                        {% if dieta.alimentos is iterable and dieta.alimentos is not empty %}
                                            {% for alimento in dieta.alimentos %}
                                                <li>• {{ (alimento.nombre|default('N/A'))|escape('html') }} ({{ (alimento.cantidad_gramos|default('N/A'))|escape('html') }}g)</li>
                                            {% endfor %}
                                        {% elseif dieta.alimentos is not empty %}
                                            <li>{{ dieta.alimentos|default('No disponible')|escape('html') }}</li>
                                        {% else %}
                                            <li>No disponible</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning text-center mt-4">No se encontraron dietas para tu objetivo y nivel de ejercicio.</div>
        {% endif %}
    {% endif %}
</main>

<footer class="text-center py-3 bg-dark text-white">
    <p>&copy; 2025 Vida Saludable. Todos los derechos reservados.</p>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
{% endblock %}